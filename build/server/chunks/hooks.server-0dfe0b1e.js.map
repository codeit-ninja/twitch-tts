{"version":3,"file":"hooks.server-0dfe0b1e.js","sources":["../../../.svelte-kit/adapter-node-ws/chunks/hooks.server.js"],"sourcesContent":["import { CognitoIdentityClient } from \"@aws-sdk/client-cognito-identity\";\nimport { fromCognitoIdentityPool } from \"@aws-sdk/credential-provider-cognito-identity\";\nimport { C as CLIENT_ID, R as REDIRECT_URI } from \"./private.js\";\nimport { StaticAuthProvider } from \"@twurple/auth\";\nimport { ApiClient } from \"@twurple/api\";\nimport { p as prisma } from \"./prisma.js\";\nimport { e as error, r as redirect } from \"./index.js\";\nfunction sequence(...handlers) {\n  const length = handlers.length;\n  if (!length)\n    return ({ event, resolve }) => resolve(event);\n  return ({ event, resolve }) => {\n    return apply_handle(0, event, {});\n    function apply_handle(i, event2, parent_options) {\n      const handle2 = handlers[i];\n      return handle2({\n        event: event2,\n        resolve: (event3, options) => {\n          const transformPageChunk = async ({ html, done }) => {\n            if (options?.transformPageChunk) {\n              html = await options.transformPageChunk({ html, done }) ?? \"\";\n            }\n            if (parent_options?.transformPageChunk) {\n              html = await parent_options.transformPageChunk({ html, done }) ?? \"\";\n            }\n            return html;\n          };\n          const filterSerializedResponseHeaders = parent_options?.filterSerializedResponseHeaders ?? options?.filterSerializedResponseHeaders;\n          const preload = parent_options?.preload ?? options?.preload;\n          return i < length - 1 ? apply_handle(i + 1, event3, {\n            transformPageChunk,\n            filterSerializedResponseHeaders,\n            preload\n          }) : resolve(event3, { transformPageChunk, filterSerializedResponseHeaders, preload });\n        }\n      });\n    }\n  };\n}\nasync function getUser(token, throwErr = true) {\n  return await prisma.userTwitchTokenData[throwErr ? \"findFirstOrThrow\" : \"findFirst\"]({\n    where: {\n      accessToken: token\n    },\n    include: {\n      user: true\n    }\n  });\n}\nconst getCurrentUser = async (token) => {\n  return await getUser(token, true);\n};\nconst getUserByEmail = async (email) => {\n  return await prisma.user.findFirst({\n    where: {\n      email\n    },\n    include: {\n      UserTwitchTokenData: true\n    }\n  });\n};\nconst createUserByToken = async ({ accessToken, expiresIn, obtainmentTimestamp, refreshToken, scope }) => {\n  const twitchUser = await getTwitchUser(accessToken);\n  if (!twitchUser.email) {\n    error(404, \"Could not link your twitch email.\");\n  }\n  return await prisma.userTwitchTokenData.create({\n    data: {\n      accessToken,\n      expiresIn,\n      obtainmentTimestamp,\n      refreshToken,\n      scope,\n      user: {\n        create: {\n          email: twitchUser.email,\n          password: \"NULL\",\n          username: twitchUser.displayName\n        }\n      }\n    },\n    include: {\n      user: true\n    }\n  });\n};\nconst updateOrCreateToken = async (user, token) => {\n  if (!user) {\n    return await createUserByToken(token);\n  }\n  return await updateTokenForUser(user, token);\n};\nconst updateTokenForUser = async ({ email, id }, { accessToken, expiresIn, obtainmentTimestamp, refreshToken, scope }) => {\n  return await prisma.userTwitchTokenData.update({\n    where: {\n      userId: id\n    },\n    data: {\n      accessToken,\n      expiresIn,\n      obtainmentTimestamp,\n      refreshToken,\n      scope,\n      user: { connect: { email } }\n    }\n  });\n};\nconst createClient = (accessToken) => new ApiClient({ authProvider: new StaticAuthProvider(CLIENT_ID, accessToken) });\nconst getTwitchUser = async (token) => {\n  return createClient(token).users.getAuthenticatedUser(token);\n};\nconst auth = async ({ event, resolve }) => {\n  const cookie = event.cookies.get(\"token\");\n  const token = cookie ? JSON.parse(cookie) : null;\n  if (!token) {\n    if (event.route.id?.startsWith(\"/auth\")) {\n      return await resolve(event);\n    }\n    const params = new URLSearchParams({\n      response_type: \"code\",\n      client_id: CLIENT_ID,\n      redirect_uri: REDIRECT_URI,\n      scope: [\n        \"user:read:email\",\n        \"chat:read\",\n        \"chat:edit\",\n        \"user:read:chat\",\n        \"user:write:chat\",\n        \"whispers:read\",\n        \"channel:moderate\",\n        \"channel:read:redemptions\",\n        \"channel:manage:redemptions\"\n      ].join(\" \")\n    });\n    return redirect(302, `https://id.twitch.tv/oauth2/authorize?${params.toString()}`);\n  }\n  const twitchUser = await getTwitchUser(token.accessToken);\n  const user = await getUserByEmail(twitchUser.email);\n  await updateOrCreateToken(user, token);\n  event.locals.user = await getCurrentUser(token.accessToken);\n  event.locals.twitchUserId = twitchUser.id;\n  return await resolve(event);\n};\nconst aws = async ({ event, resolve }) => {\n  const cognitoidentity = new CognitoIdentityClient({\n    credentials: fromCognitoIdentityPool({\n      client: new CognitoIdentityClient({ region: \"us-east-1\" }),\n      identityPoolId: \"us-east-1:20b7d50c-d752-4f3e-9f70-2a5335f01e92\"\n    })\n  });\n  event.locals.credentials = await cognitoidentity.config.credentials();\n  const response = await resolve(event);\n  return response;\n};\nconst handle = sequence(auth, aws);\nexport {\n  aws,\n  handle\n};\n"],"names":[],"mappings":"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"}